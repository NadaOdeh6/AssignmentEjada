package apitest;

import io.restassured.RestAssured;
import io.restassured.response.Response;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import static io.restassured.RestAssured.*;
import static org.hamcrest.Matchers.*;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;


public class APITests {
	 private static String accessToken;
     public String createdOrderId; 
	    @BeforeAll
	    public static void setup() {
	    	DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyyMMddHHmmssSSS");
	    	 LocalDateTime currentDate = LocalDateTime.now();
	    	 String formattedDateTime = currentDate.format(formatter);
	    	 
	    	 String name = "Nada" + formattedDateTime;
	    	 
	        RestAssured.baseURI = "https://simple-books-api.glitch.me";
	        System.out.println(name);
	        // Register the API client and obtain the access token
	        String requestBody = "{\n" +
	                "  \"clientName\": \"" + name + "\",\n" +
	                "  \"clientEmail\": \""+ name +"@example.com\"\n" +
	                "}";
	        
	        System.out.println(requestBody);

	        Response response = given()
	                .header("Content-Type", "application/json")
	                .body(requestBody)
	                .when()
	                .post("/api-clients/")  
	                .then()
	                .log().all()  // Log the response for debugging
	                .extract()
	                .response();

	        int statusCode = response.getStatusCode();

	        if (statusCode == 201) {
	            // Success: Extract and store the access token
	            accessToken = response.jsonPath().getString("accessToken");
	            System.out.println("Access token received: " + accessToken);
	        } else if (statusCode == 409) {
	            System.out.println("Client already registered. Please use a different email and name.");
	        } else if (statusCode == 404) {
	            System.out.println("The endpoint was not found. Please check the URL.");
	        } else {
	            System.out.println("Unexpected status code: " + statusCode);
	        }
	    }
	    
	    @Test
	    public void getAllBooks() {
	    	   Response response = given()
	    	            .auth()
	    	            .oauth2(accessToken)  // Bearer Token Authentication
	    	        .when()
	    	            .get("/books")
	    	        .then()
	    	            .statusCode(200)  
	    	            .extract()
	    	            .response();

	    	        System.out.println("Response: " + response.asString());
	    	    
		       
//	        given()
//	        .when()
//	            .get("/books")
//	        .then()
//	            .statusCode(200) // Expecting successful retrieval
//	            .body("size()", greaterThan(0)); // Check that there is at least one book
	    }
	    
	    @Test
	    public void testPostOrder() {
	        String requestBody = "{\n" +
	                "  \"bookId\": 1,\n" +
	                "  \"customerName\": \"John Doe\"\n" +
	                "}";

//	        given()
//	            .header("Authorization", "Bearer " + accessToken)  // Use the access token here
//	            .header("Content-Type", "application/json")
//	            .body(requestBody)
//	            .when()
//	            .post("/orders")
//	            .then()
//	            .statusCode(201)
	            
	        
	        Response response = given()
		            .auth()
		            .oauth2(accessToken)  // Bearer Token Authentication
		        .when()
		            .get("/orders")
		        .then()
		            .statusCode(200)  // Expecting successful retrieval of orders
		            .body("created", equalTo(true))
		            .extract()
		            .response();
	        
	        createdOrderId =  response.jsonPath().getString("orderId");
	    }
	    
	    @Test
	    public void getAllOrders() {
	        Response response = given()
	            .auth()
	            .oauth2(accessToken)  // Bearer Token Authentication
	        .when()
	            .get("/orders")
	        .then()
	            .statusCode(200)  // Expecting successful retrieval of orders
	            .extract()
	            .response();
	        
	        
	    }
	    
	    

	    @Test
	    public void testPatchOrder() {
	        String requestBody = "{\n" +
	                "  \"customerName\": \"Jane Doe\"\n" +
	                "}";


	        given()
	            .header("Authorization", "Bearer " + accessToken)  // Use the access token here
	            .header("Content-Type", "application/json")
	            .body(requestBody)
	            .when()
	            .patch("/orders/" + createdOrderId)
	            .then()
	            .statusCode(204);
	    }

	    @Test
	    public void testDeleteOrder() {

	        given()
	            .header("Authorization", "Bearer " + accessToken)  // Use the access token here
	            .when()
	            .delete("/orders/" + createdOrderId)
	            .then()
	            .statusCode(204);
	    }
}
